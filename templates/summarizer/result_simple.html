{% extends 'base.html' %}

{% block title %}Summary Results - AI Student{% endblock %}

{% block content %}
<div class="results-section">
    <div class="container">
        <!-- Video Info -->
        <div class="video-info-card">
            <div class="video-header">
                <div class="video-icon">
                    <i class="fab fa-youtube"></i>
                </div>
                <div class="video-details">
                    <h2 class="video-title">{{ video_title }}</h2>
                    <div class="video-meta">
                        <span class="channel">
                            <i class="fas fa-user"></i>
                            {{ channel }}
                        </span>
                        <span class="duration">
                            <i class="fas fa-clock"></i>
                            {{ duration }}
                        </span>
                        <span class="processing-time">
                            <i class="fas fa-tachometer-alt"></i>
                            Processed in {{ processing_time|floatformat:1 }}s
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="summary-card executive-summary">
            <div class="card-header">
                <h3>
                    <i class="fas fa-file-alt"></i>
                    Executive Summary
                </h3>
            </div>
            <div class="card-content">
                <p>{{ executive_summary }}</p>
            </div>
        </div>

        <!-- Timestamps -->
        <div class="summary-card timestamps-section">
            <div class="card-header">
                <h3>
                    <i class="fas fa-clock"></i>
                    Smart Timestamps
                </h3>
                <span class="timestamp-count">{{ timestamps|length }} sections</span>
            </div>
            <div class="timestamps-grid">
                {% for timestamp in timestamps %}
                <div class="timestamp-card" onclick="scrollToSection({{ forloop.counter }})">
                    <div class="timestamp-time">{{ timestamp.time }}</div>
                    <div class="timestamp-title">{{ timestamp.title }}</div>
                    <div class="timestamp-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Full Summary -->
        <div class="summary-card full-summary">
            <div class="card-header">
                <h3>
                    <i class="fas fa-book-open"></i>
                    Full Summary
                </h3>
            </div>
            <div class="card-content">
                <div class="summary-text">
                    {{ full_summary|linebreaks }}
                </div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="download-section">
            <div class="download-card">
                <div class="download-content">
                    <div class="download-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="download-info">
                        <h4>Download Summary as PDF</h4>
                        <p>Get a beautifully formatted PDF with all the content for offline study</p>
                    </div>
                </div>
                <button class="btn btn-primary btn-large" onclick="downloadPDF()">
                    <i class="fas fa-download"></i>
                    Download PDF
                </button>
            </div>
        </div>

        <!-- Back to Home -->
        <div class="back-section">
            <a href="{% url 'summarizer:home' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Process Another Video
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function scrollToSection(sectionNumber) {
    // Scroll to the full summary section
    const fullSummary = document.querySelector('.full-summary');
    if (fullSummary) {
        fullSummary.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }
}

function downloadPDF() {
    const filename = `summary_${encodeURIComponent('{{ video_title }}')}_${new Date().toISOString().slice(0,10)}.pdf`;
    
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
    btn.disabled = true;
    
    // Make download request
    fetch(`/download/${filename}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('PDF generation failed');
        }
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        showSuccessMessage('PDF downloaded successfully!');
    })
    .catch(error => {
        console.error('Download error:', error);
        showError('Failed to download PDF. Please try again.');
    })
    .finally(() => {
        // Restore button
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function showSuccessMessage(message) {
    // Create success notification
    const notification = document.createElement('div');
    notification.className = 'success-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: var(--text-primary);
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        animation: slideInRight 0.3s ease-out;
    `;
    
    notification.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function showError(message) {
    const modal = document.getElementById('error-modal');
    const messageEl = document.getElementById('error-message');
    
    if (modal && messageEl) {
        messageEl.textContent = message;
        modal.style.display = 'flex';
    }
}
</script>
{% endblock %} 